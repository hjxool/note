## CDN

### 概念

- CDN：全名内容分发网络，指通过互联网互相连接的电脑网络系统，利用最靠近每位用户的服务器，更快、更可靠地将音乐、图片、视频、应用程序及其他文件发送给用户

### 作用

- 用于托管Web资源(图片、js文件等)，可供下载的资源(媒体文件、软件等)，使用CDN可以加速这类资源的访问
  - 性能方面
    - 内容来自最近的数据中心，延迟更低
    - 资源请求分配给CDN，减轻服务器负载压力
  - 安全方面
    - CDN会防御网络攻击，限制请求频率，并且对整个通信链路用HTTPS加密

### 原理

- CDN与DNS有着联系
  - 输入`www.xxx.com`域名后DNS解析过程
    1. 检查浏览器缓存
    2. 检查操作系统缓存，如`hosts`文件
    3. 检查路由器缓存
    4. 前几步没找到，则会向ISP(网络服务提供商)的LDNS服务器查询
    5. 如果LDNS没找到，则会向根域名服务器请求
    6. 最终得到域名对应的IP地址
- CDN工作原理
  1. 当DNS发现URL对应的是CDN专用的DNS服务器，会将域名解析权交给CDN专用的DNS服务器，CDN专用DNS服务器将CND的全局负载均衡设备IP地址返回给用户
  2. 客户端向CDN的全局负载均衡设备发起数据请求
  3. CDN的全局负载均衡设备根据用户的IP地址、URL，选择一台用户所属区域的区域负载均衡设备，告诉用户向这台设备发起请求
  4. 区域负载均衡设备选择一台合适的缓存服务器来提供服务，将该缓存服务器的IP地址返回给全局负载均衡设备
  5. 全局负载均衡设备把服务器的IP地址返回给用户
  6. 用户向该缓存服务器发起请求，缓存服务器响应用户的请求，将用户所需内容发送至用户终端

### 使用场景

- 第三方的CDN服务
  - 当想要开源一些项目，可以使用第三方的CDN服务
- 静态资源的缓存
  - 将网站的静态资源放在CDN上，比如js、css、图片等。可以将整个项目放在CDN上，完成一键部署

- 直播传输
  - 直播本质上是使用流媒体进行传输，CDN也支持流媒体，所以直播完全可以使用CDN来提高访问速度
  - CDN在处理流媒体的时候与处理普通静态文件有所不同。普通文件如果在边缘节点没有找到的话，就会去上一层接着寻找，但是流媒体本身数据量就非常大，如果使用回源的方式，必然会带来性能问题，所以流媒体一般采用的都是主动推送的方式来进行

## 懒加载

### 概念

- 在长网页中延迟加载==图片==数据，是一种较好的网页性能优化的方式，只加载用户视窗口能看到的那一部分图片数据

### 使用场景

- 图片较多、长列表场景

### 原理

- 图片加载是由`src`引起，当对`src`赋值时，浏览器就会请求图片资源，根据这个原理，使用HTML5 的`data-xxx`==自定义标签属性来储存图片的路径==，在需要加载图片的时候，将`data-xxx`中图片的路径赋值给`src`，这样就实现了图片的按需加载
- 重点在于确定用户需要加载哪张图片，通过以下几个属性判断
  - `innerHeight` 可视区域的高度
  - `scrollTop` 滚动过的距离
  - `imgs.offsetTop` 是元素顶部距离文档顶部的高度（包括滚动条的距离）
  - 图片加载条件：`img.offsetTop < dom.innerHeight + dom.scrollTop`

## 回流与重绘

### 触发条件

- 回流
  - 概念
    - 渲染树中元素==尺寸、排列顺序、属性发生变化时==，浏览器重新渲染过程
  - 导致回流的操作
    - 页面首次渲染
    - 浏览器窗口大小发生变化
    - 元素内容变化
    - 元素尺寸或位置变化
    - 元素字体大小变化
    - 激活CSS伪类
    - 查询某些属性或调用某些方法
    - 添加/删除==可见==dom元素
- 重绘
  - 概念
    - 元素样式发生变化，但不影响其在文档流中的位置时，浏览器会对其重新绘制
  - 导致回流的操作
    - `color`、`background`相关属性
    - `outline`相关属性
    - `border-radius`、`visibility`、`box-shadow`等
- 当触发==回流==时，**一定**会触发重绘，但是==重绘==不一定引发回流

### 如何避免回流和重绘

- 操作DOM时，尽量在低层级DOM节点进行操作
- 不要使用`table`布局，一个小的改动可能使整个`table`重新布局
- 使用CSS的表达式
- 不要频繁操作元素样式，可以修改类名，而不是样式
- 使用`absolute`或者`fixed`，使元素脱离文档流，这样他们发生变化就不会影响其他元素
- 可以创建一个虚拟DOM`documentFragment`，在它上面应用所有DOM操作，最后再把它添加到文档中
- 将元素先设置`display: none`，操作结束后再把它显示出来。因为在隐藏显示的元素上进行的DOM操作不会引发回流和重绘
- 将DOM的多个读操作（或者写操作）放在一起，而不是读写操作穿插着写

### 如何优化动画

- 动画会频繁的操作DOM，导致页面性能变差
- 可以将动画的`position`属性设置为`absolute`或`fixed`，使元素脱离文档流，这样就不会触发页面回流

### documentFragment 是什么？用它跟直接操作 DOM 的区别是什么?

- `documentFragment`

  - 定义

    - ==文档片段==接口，==没有父对象==的最小文档对象，可以作为一个轻量版的`document`使用，像标准的`document`一样，存储由节点(`nodes`)组成的文档结构

  - 与直接操作`document`的区别

    - `DocumentFragment`不是真实 DOM 树的一部分，它的变化不会触发 DOM 树的重新渲染，且不会导致性能等问题
    - 当把`DocumentFragment`节点插入文档树时，插入的不是`DocumentFragment`自身，而是它的所有子孙节点

    - 需要频繁操作DOM时，将真实DOM元素插入`DocumentFragment`，之后一次性将所有子孙节点插入真实DOM中，与直接操作DOM相比，`DocumentFragment`节点插入DOM树时，不会触发页面的重绘，这样就大大提高了页面的性能

## 防抖和节流

- 节流

  - 在单位时间内，只能有一次触发
  - 使用场景
    - 拖拽，方式高频次触发位置变动
    - 缩放，监听浏览器`resize`
    - 动画，避免多次触发动画引起性能问题

  ```js
  function throttle(fn, delay) {
      let timer
      return function (...params) {
          if (!timer) {
              timer = true
              fn(...params)
              setTimeout(() => {
                  timer = false
              }, delay)
          }
      }
  }
  ```

- 防抖

  - 事件被触发 n 秒后，如果 n 秒内再次被触发，则重新计时。
  - 使用场景
    - 按钮提交，限制点击频率
    - 服务端验证。表单验证需要服务端配合，只执行连续输入事件的最后一次，以及搜索联想词

  ```js
  function debounce(fn, delay) {
      let timer
      return function (...params) {
          clearTimeout(timer)
          timer = setTimeout(() => {
              fn(...params)
          }, delay)
      }
  }
  ```

## 图片优化

- 如何对项目中图片进行优化
  - 不用图片，使用CSS代替
  - 对于图片清晰度要求不高的，使用**CDN加载**
  - **小图**使用`base64`格式
  - 多个**图标**整合到一张图中(雪碧图)
  - 选择正确的图片格式
    - 小图使用`PNG`，可以用SVG代替
    - 照片用`JPEG`
    - `WebP`格式具有更好的图像数据压缩算法，带来更小的图片体积，且无差别图像质量，但不是所有浏览器支持

## webpack优化

### 如何提高打包速度

- 见`工程化.md`

### 如何减少打包体积

- 见`工程化.md`