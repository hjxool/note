## 嵌入式微处理器体系结构

### 冯·诺依曼体系结构

- 也称==普林斯顿结构==

- （考点）特点

  1. 程序（指令）和数据==共用==一个==存储空间==。指令和数据放在同一存储器的==不同地址==上

  2. ==单一==的地址和数据==总线==，地址总线和数据总线传输数据的二进制位数相同
     - 注：**地址**总线是**单向**，**数据**总线是**双向**，只有一条总线，传输地址时是单向，传输数据时是双向，在不同时间段进行

  3. ==串行执行==

     - 流程：CPU==执行指令==时，先从存储器(如内存)中取指令地址(==取址==)，再通过==总线==传回CPU，CPU将其递给 ==寄存器== ，对指令进行解码，取操作数(==取数==)的地址，再走 地址==总线== 找到存储的==数据==，取出数据通过==总线==返回给CPU

     - ==串行==的理解
       1. 必须**先**取址，**才能**取数据
       2. 总线不能并行，总线**不能同时执行**传数据和传地址

### 哈佛体系结构

- （考点）特点
  1. 程序（指令）和数据存在==**不同**存储空间==，==各存储器**独立**编址、**独立**访问==
     - 程序存储器和数据存储器物理上相互独立
     - 独立编址：如两栋楼，都有12层
  2. ==独立==的**地址**和**数据**==总线==，两个存储器对应两套独立的地址总线和数据总线
  3. ==并行==执行，提高速度
     - 并行不是指取址、取数乱执行，执行还是按先后顺序执行，但是因为分成了不同的设备，有不同的线路，所以在第一条取址的设备操作完，轮到另一设备进行取数时，取址的设备就可以第二条指令的取址操作了

### 两者区别

- 冯·诺依曼 是==单车道==，哈佛 是==多车道==
- 冯·诺依曼 的好处是==简单、易于实现和设计==，哈佛 的好处 因为是多车道，==可以用不同技术优化性能==
- 冯·诺依曼 ==适用大多数计算机==，哈佛 ==适用于特定应用领域==(如DSP)

## 微处理器分类

### 按 同时处理量 分类

- 根据处理器能够==同时处理==数据的字长(字长宽度)，可分为4位、8位、16位、32位、64位

  - 16位及以==下==的称为==嵌入式微**控制器**==

  - 32位及以==上==的称为==嵌入式微**处理器**==

### 按 集成度 分类

- 按系统==集成度==划分，可分为两类

  - 微处理器内部**仅包含**==中央处理器==单元（如==CPU==），称为==一般用途型微**处理器**==

  - 将CPU、ROM、RAM、I/O等硬件==集成==到==同一芯片==（==单片机==），称为==单芯片微**控制器**==

### 按 用途 分类

#### 微控制器 MCU

- 嵌入式==微控制器**MCU**==（==CPU + 内存 + 外设==）
  - 注：因为是==控制器==，所以处理能力只有16位及以下，结合==集成度==分类，可知 MCU 是==单芯片==微控制器
  - 典型代表是==单片机==，将CPU等硬件集成在一片芯片上，形成==芯片级计算机==
  - 因为集成在芯片上，即==单片化==，所以体积大大减小，功耗和成本也降低，但体积小意味着能做的事情不能太复杂，像家用电脑一样，所以只适用于==控制==外设资源，主流是用作==嵌入式系统工业==
    - 如：遥控器、电控门等

#### 微处理器 MPU

- 嵌入式==微处理器**MPU**==（==CPU==）
  - 注：是==处理器==，所以32位以上
  - 与**计算机处理器**不同的是，==只保留和嵌入式应用紧密相关的功能硬件==，去除其他冗余功能部分，就能以==最低功耗和资源==实现嵌入式应用的特殊需求
    - 即定制CPU
  - 优点：==体积小、重量轻、成本低、可靠性高==
  - ==应用==场景：==高性能计算==和==复杂算法==处理的系统，**不过需**外挂==大容量存储器==（如DDR 和 FLASH）来支持允许复杂操作系统和大型程序
    - **复杂**算法：注意与==大量计算==区分，如1亿个`1+1`的计算，这叫**大量**计算，而 MPU 的复杂计算应对的是更==复杂的业务==计算
  - **MPU** 与 **MCU** 比较
    - 嵌入式系统**更多使用**的是微控制器（**MCU**），因为大多嵌入式系统不需要太复杂的计算，只需要根据只能做出反应即可，如无人机、遥控器。因此使用 **MCU** ==更节省成本和功耗==，并可以==简化硬件设计==
      - 举个例子，某项目需要在桥梁下安装智能终端收集桥梁震动数据，来记录有多少车辆通过，使用MCU可以坚持一年才更换电池，而MPU可能过两天就没电了
      - 所以嵌入式更多考虑的是==低功耗==这点

#### 数字信号处理器 DSP

- 嵌入式微==数字信号处理器**DSP**==
  - 专门用于==信号处理==方面的处理器，在**系统结构**和**指令算法**方面进行了特殊设计，具有很==高==的==编译效率==和指令==执行速度==
  - 采用==哈佛==结构，流水线处理，处理速度比最快的CPU还快10~50倍，强大的==数据处理能力==，和==高运行速度==是两大特色
    - 对比 **MPU** 的复杂算法处理，**DSP** 更擅长==大量==的简单计算
  - 应用
    - ==通信==领域：用于调制解调、信道编解码等
      - 如：==GSM==、==CDMA==、==LTE==等打电话用到的通信场景都用DSP
    - ==音频==领域：音频编解码、声音增强、**降噪**、回声抑制、**语音识别**等
      - 如：手机、耳机
    - ==图像==处理领域：图像压缩、图像增强、边缘检测等
      - 如：数字相机、手机摄像头、监控、医疗图像等
    - ==雷达==和==信号==处理领域：雷达信号处理、目标跟踪、信号分析等
      - 如：航空、汽车、等
    - ==控制==领域：机器人、航天飞行器等
      - 如：自适应控制、PID控制等
    - 生物==医学==领域：心电信号处理、医学影像、脑电信号等
      - 如：心电图、**CT**等

#### 片上系统 SoC

- 嵌入式==片上系统**SoC**==
  - 题外话：华为的芯片大战，聚焦点就是SoC
  - **类似** ==MCU(单片机)== 将各种硬件集成到芯片上，分为==控制部件==（**微处理器**、存储器）和==执行部件==（**I/O**接口、微型开关、微机械），但与 MCU 的**区别是**==软硬件结合==，直接将==操作系统代码==存储在Flash==存储器==中。是一个有**专用目标**的集成电路，包含操作系统和对应==功能软件==
    - 如高端SoC芯片用于**手机**、**平板电脑**等
    - 次高端SoC芯片用于安防、**物联网**等领域
    - 专用型SoC芯片用于**智能手表**等
  - SoC采用了==片内可再编程技术==，使SoC内硬件功能可以像软件一样通过编程来配置，从而灵活的修改和开发
    - 片内可再编程技术：即所谓的==刷机==，类似于重新安装电脑系统。而新刷入的系统如何支持原有硬件，依赖于==驱动程序==。==驱动程序是操作系统与硬件之间的桥梁==，它们负责控制和管理硬件设备。==每个硬件设备都有对应的驱动程序==，操作系统通过这些驱动程序与硬件进行通信。所以刷机的新系统只要==携带对应驱动程序==就仍可以控制原有硬件功能

## 多核处理器

### 基本概念

- 单 CPU 从微观上来看是串行执行任务，宏观上是并行，而原先想要让任务在微观层面也能够并行执行，就得安插多个 CPU ，这也意味着需要多个供电插槽，而随着芯片技术发展，现在已经可以一个芯片内装多个==微处理器==，即所谓的==多核==处理器
- ==多核==指==多个微处理器==内核，是将==多个微处理器==集成在==单枚芯片==中，这样只需要单个处理器插槽
- ==多核==与==多CPU==对比，很好的==降低==了计算机==功耗==和==体积==
- 多核技术中，操作系统可进行==调度==、==多进程==、==多线程并发==

### 运行模式

- 为了更合理的分配微处理器资源，就有了三种运行模式，具体使用哪种，取决于==应用场景==和==硬件差异==

#### 非对称 多处理 AMP

- 两个处理内核职责并不相同，各自处理==特定的功能==，在==软件协调==下分担不同计算任务
  - 类似CPU和GPU，后者关注图像和人工智能的计算

#### 对称 多处理 SMP

- 两颗==完全一样==的处理器，达到双倍或接近双倍的处理性能，节省运算资源

#### 混合 多处理 BMP

- 两颗==完全一样==的处理器，**但**可以==指定==**任务**仅在指定**内核**上执行

### 调度情况

- 当有多个任务运行，如何进行CPU分配

#### 全局队列调度

- 操作系统维护一个==全局的任务等待队列==，这个队列里全是等待执行的任务，当有CPU空闲时，操作系统就从全局队列中选取就绪任务开始执行
  - 简单记：看哪个闲，让哪个工作
- 优点：==CPU核心利用率高==

#### 局部队列

- 为==每个CPU==维护一个==局部==的任务等待==队列==，只有对应CPU的局部队列有任务，才会让对应CPU去工作
- 优点：无需在多个CPU之间切换

## 嵌入式系统

- 与嵌入式操作系统的区别
  - 嵌入式系统是从整体描述
  - 嵌入式操作系统则是其中的软件组成部分

### 组成

- ==硬件==部分
  - 嵌入式==处理器==
    - 除了前述==低功耗、体积小==等需求，根据不同环境，==工艺==上可分为==民用==、==工业==、==军用==三个档次
  - 相关==支撑**硬件**==
    - 指==除了==嵌入式==处理器以外==的==其他硬件==，包括存储器、定时器、总线、I/O接口及专用硬件
- ==软件==部分
  - ==嵌入式操作系统==
    - （考点）与==通用操作系统==的**不同**：嵌入式操作系统应具备==实时==性、==可裁剪==性、==安全==性等特征
      - 可裁剪性：即系统==定制化开发==
  - ==支撑软件==
    - 指为**应用软件**开发运行提供==公共服务==、软件==开发==、==调试==能力的==软件==，支撑软件的公共服务通常运行在操作系统之上，以==库==的方式被应用软件调用
  - ==应用软件==
    - 为嵌入式系统的某一特定目标所开发的软件，即嵌入式软件，嵌入式开发人员主要开发的就是这块

### 特性

- 与 通用系统 相比，具有以下特性
  - ==专用性强==：面向特定需求开发。如洗衣机、微波炉
  - ==技术融合==：嵌入式是将==计算机技术、通信技术、半导体技术和电子技术==与各个行业的应用等融合到一起实施的，是==技术密集、资金密集、高度分散、不断创新的知识集成系统==
  - ==软硬一体软件为主==：嵌入式开发不仅要懂软件开发还要懂硬件，但主要还是以软件为主
  - ==比通用计算机资源少==：嵌入式系统任务比起通用计算机简单的多，自然用到的资源就少
  - ==程序代码固化在非易失存储器中==：通用计算机操作系统、程序代码是固化在外置硬盘中，而嵌入式为了提高速度和系统可靠性，程序代码==固化在存储芯片或单片机本身==中
  - ==需要专门开发工具和环境==：嵌入式系统本身不具备开发能力，而是在PC上通过一套开发工具和环境进行开发，再写入到嵌入式芯片中
  - ==体积小、价格低、工艺先进、系统配置要求低、实时性强==
  - ==对安全性和可靠性要求高==

### 分类

- 嵌入式系统分为==硬件==层、==抽象==层、==操作系统==层、==中间件==层和==应用==层
  1. 硬件层：为嵌入式系统提供运行所需的硬件环境
  2. 抽象层：硬件层 和 操作系统层 之间，主要实==对硬件层的硬件进行抽象==，减少 硬件层 和 操作系统层 之间的耦合度，因为 硬件层 硬件五花八门，而 操作系统层 是相对固定的，为减少不同硬件对操作系统的影响，就需要 抽象层 对硬件进行抽象，操作系统层 调用的是 抽象层 提供的虚拟硬件资源，而非直接调用硬件
     - ==板级支持包==（**BSP**）
       - ==介于主板**硬件**和操作系统中**驱动程序之间**的一层==，属于==设备驱动层==，一般认为它属于操作系统一部分，为操作系统中的驱动程序提供访问硬件的函数包
       - 主要目的是为了==屏蔽底层硬件的多样性==
       - 具体功能
         - ==单板硬件初始化==，即CPU初始化
         - 为操作系统提供设备==驱动程序==和系统==中断服务==程序
         - 定制操作系统功能，为软件系统提供一个实时多任务的运行环境
         - ==初始化操作系统==
       - 特点
         - ==硬件相关性==：与硬件相关，作为抽象层的具体应用，需要与硬件交互，为上层提供服务
         - ==操作系统相关性==：作为承上启下，还要与操作系统相关联，为其提供接口
       - **BSP** 主要包含两个方面
         - ==引导加载程序BoottLoader==
           - 类似PC的BIOS引导程序，是加电后==第一段软件代码==，用于==初始化硬件==、==建立内存空间映射图==，从底往上分别包含以下功能
             1. ==片级==（芯片/处理器）==初始化==
                - 微处理器初始化，包括设置寄存器、局部总线模式等，把微处理器从上电时的默认状态设置成操作系统要求的工作状态，是==**纯硬件**的初始化过程==
             2. ==板级==（主板以及上面其他硬件）初始化
                - 除了处理器初始化，还要初始化设置其他硬件，这就涉及到其他硬件的软件参数设置，因此，是==同时包含软件和硬件==在内的初始化过程
             3. ==加载内核==（==系统级==初始化）
                - 加载操作系统，==将操作系统和应用程序代码从Flash存储器（外存）上复制到系统内存中==，然后跳转系统内核的第一条指令处执行
         - ==设备驱动程序==
           - 对一个嵌入式系统来说，它可以没有操作系统，但不能没有驱动程序，如冰箱里用的嵌入式系统，它只需要简单的接收设备传来的信号做出反应即可，不需要操作系统
           - ==设备驱动程序==就是一组==库函数==，用来对硬件进行初始化和管理，并向上层软件提供访问接口
           - 设备驱动程序 共同的一些基本功能：硬件启动（开机时）、硬件关闭、硬件停用 、硬件启用（暂停后恢复）、读操作、写操作
  3. 操作系统层：由嵌入式操作系统、文件系统、图形用户接口、网络系统等模块组成
  4. 中间件层：位于操作系统之上，管理计算机资源和网络通信，是连接两个独立应用的桥梁
  5. 应用层：即不同的应用软件

## 嵌入式操作系统（EOS）

### 基本概念

- EOS 负责==软硬件资源==分配、==任务调度==
- 与 通用操作系统 对比，具有以下特点
  - ==微型化==：EOS 运行平台不是计算机而是嵌入式系统，这类系统没有大容量内存和外存，因此 EOS 必须做的小巧，占用==尽量少==的==系统资源==
  - ==代码质量高==：在嵌入式应用中，存储空间是宝贵的资源，因此==代码==应尽可能==精简==，且足够完成任务
  - ==专业化==：硬件平台多种多样，因此处理器也是针对不同==应用领域==而==专门设计==的
  - ==实时性强==：比如导弹发射随时可以控制返回或改位置，不可能指令发了半天反应不过来
  - ==可裁剪、可配置==：嵌入式系统 具备可裁剪、可配置，操作系统也应具有这样的特点，针对不同应用领域的需求，做到微型、专业化

### 嵌入式实时操作系统（RTOS）

- 与非实时嵌入式操作系统相比，具有以下特点
  - 外部事件和数据产生时，能够以==足够快==的速度接收并处理
- 嵌入式实时系统 要求==系统在投入运行前具有确定性和可预测性==
  - 确定性：在==给定的初始状态和输入条件下，在确定时间内给出确定的结果==，如计算器计算输入必定给出确定的结果
  - 可预测性：系统在==运行前，其功能、响应特性、执行结果是可预测的==，如运行时不可能发生突兀情况
- 工业控制、军事、航天等领域对系统响应时间有苛刻要求，就需要使用实时系统，而其==足够快==的特性并不是说要立刻完成，而是分为硬和软两种维度评测
  - ==硬实时==操作系统：在==规定时间内==必须完成
  - ==软实时==操作系统：==按==照任务==优先级完成==即可
- 实时操作系统 特征
  - ==**高精度**计时系统==
    - ==计时精度是影响实时性的一个重要因素==，不仅要求==硬件==提供的时钟==精度==，也依赖==实时操作系统==（软件）实现的高精度==计时功能==
    - 如导弹，计时不准可能造成严重后果
  - ==多级中断机制==
    - 处理外部事件和信息，有轻重缓急之分，有的必须立即作出反应，有的可以延后处理，而紧急的事件里又有更紧急的，因此==需要建立多级中断**嵌套**处理机制，以确保紧迫程度较高的及时响应和处理==
  - ==实时调度机制==
    - 简单来说，就是不紧急的任务中断了，原先靠后的紧急的任务就得快速调用起来
    - 实时系统==不仅要及时==响应事件==中断==，==也要及时==调度==运行==实时任务，因为涉及两个进程之间的切换，只能==在确保”安全切换“的时间点上==进行
      - ”安全切换“的时间点：如果了解Java，就知道有JVM这一垃圾回收机制，它不是立即执行，而是停在某一时间点上时，确保不会影响到程序运行才会执行，实时系统也是如此
    - 实时调度机制 包含两个方面
      - ==调度策略==和==算法==上保证优先调度实时任务
      - ==建立更多”安全切换“时间点==，保证及时调度

## 嵌入式软件

- 嵌入式系统中的==所有类型软件==

### 按 功能 分类

- 系统软件
  - ==管理和控制==嵌入式系统==资源==，为嵌入式应用==提供支持==的软件，如驱动程序、操作系统、中间件等
    - 中间件：如EDBMS
- 应用软件
  - 系统中的==上层软件==，定义了==设备==的主要==功能和用途==，负责与==用户交互==，==面向特定应用场景==，如飞行控制、地图等
- 支撑软件
  - ==辅助==软件==开发==的工具软件，如在线仿真工具，分析设计工具

### 嵌入式软件 设计

- 嵌入式软件要进行==低功耗==设计，主要技术有：==编译优化==技术、==软硬件协同==设计、==算法优化==
  - 编译优化：代码行数要少
  - 软硬件协同：硬件不一定用最好的，用最适合搭配软件的硬件即可，因为好的硬件可能功耗越高
  - 算法优化：就是代码运行效率要高，如1~100相加，优化算法比从头加到尾效率要高
- 嵌入式软件的==特点==：规模==小==、==开发难度大==、==实时==性和==可靠==性高、要求==固化存储==

### 嵌入式软件 开发

- 分为以下几个阶段
  - ==编码==
    - 即在PC上使用==编辑器==开发软件
  - ==交叉编译==
    - 即==在一个平台上生成可以在另一个平台上执行的代码==，只有嵌入式开发的编译叫==交叉编译==
    - 但是开发的软件使用的是高级语言，要让机器能看懂，就得通过==交叉编译工具==（如==编译器gcc==）处理源代码，生成CPU可执行的二进制文件
    - PC和嵌入式设备系统不一样，需要交叉编译，GUN C/C++（gcc）是目前常用的交叉编译器
  - ==交叉调试==
    - 交叉调试 是必不可少的一环，==调试器gdb==是GUN开源组织发布的一个强大的调试工具
    - 嵌入式开发调试特点：
      - ==**调试器**运行在PC上==，被调试==**程序**运行在嵌入式设备上==。==调试器==通过某种==通信==方式与==嵌入式设备==建立联系，如串口、网络、JTAG
      - 嵌入式设备上一般有==调试器==的某种==代理==，能配合调试器完成对嵌入式设备上==运行程序==的调试，可以是==软件==或支持调试的==硬件==

### 嵌入式数据库系统 EDBMS（中间件）

#### 按==存储位置==进行分类

- 基于==内存==方式（==MMDB==）
  - 定义：==实时系统==和==数据库==系统的有机==结合==
    - 因为内存读写比外存储器快，所以实时系统用这个方式
  - 特点：内存数据库是支持实时事务的最佳技术，本质特征为“主==拷贝==”或“工作版本”==常驻内存==，==事务==**只与**数据库的==内存拷贝==打交道
- 基于==文件==方式（==FDB==）
  - 定义：以==文件形式==存储数据库数据，即数据按照一定格式==存在磁盘==中。应用程序==通过驱动程序==或者==直接==对数据文件进行==读写==
  - 特点：这种数据库访问方式是被动的，只要了解其文件格式，任何程序都可直接读取，因此==安全性很低==，但是==可以满足在空间、时间等方面的有特殊需求的嵌入式系统==
- 基于==网络==方式（==NDB==）
  - 定义：基于==手机4G/5G移动通信==基础上的数据库系统。可以把嵌入式设备看作==访问远程服务器的客户端==
  - 特点：网络数据库==无需解析SQL语句==、==支持更多SQL操作==、==嵌入式设备小，无需剪裁==、利于==代码复用==

#### 使用环境的特点

- 以下以手机为例

1. ==设备随时移动==：==嵌入式数据库==主要用在==移动设备==上，设备位置经常随使用者移动
2. ==网络频繁断开==：移动设备的位置经常发生变化，同时受电源、网络等因素影响，所以一般不会持续保持网络连接，而是经常==主动或被动==的==间歇性==断开和==连接==
3. ==网络条件多样化==：有WI-FI、5G、4G等环境，位置发生变化时，可能通过不同网络进行连接
4. ==通信能力不对等==：手机一般都是速度比较差的移动网络，而服务器基本都是宽带，所以手机的上行和服务器的下行通信能力不对等

#### 网络数据库系统（NDB）组成

- 一个完整的==数据库系统==由若干==子系统组成==，包括==主数据库==、==同步服务器==、==嵌入式数据库==、==连接网络==等子系统
- NDB 需要==解决==好数据的==一致性（复制性）==、==高效==的事务处理和数据的==安全==性等关键问题